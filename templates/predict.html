{% extends "base.html" %}
{% block title %}Predict - ATR App{% endblock %}
{% block content %}
<style>
    /* Dark background, light text for visibility */
    body { background-color: #121212 !important; color: #f1f1f1 !important; }  /* Dark background, light text */
    .card { background-color: #1e1e1e !important; color: #f1f1f1 !important; }  /* Dark card background */
    #status, #predLabel, #predDesc { color: #f1f1f1 !important; }  /* Prediction text in light color */
    .text-muted { color: #b0b0b0 !important; }  /* Muted text lighter gray */
    .alert { color: #ff6b6b !important; }  /* Light red for error alerts */
    .btn { color: #ffffff !important; background-color: #3a3a3a !important; border: 1px solid #555555 !important; }  /* Buttons with dark background */
    /* Additional overrides for specific elements */
    #resultCard { background-color: #1e1e1e !important; border: 1px solid #333333 !important; }
    h2, h4 { color: #f1f1f1 !important; }  /* Headings in light color */
</style>


<div class="container">
    <h2 class="text-center">Upload & Predict SAR Image</h2>
    <div class="row">
        <div class="col-md-6">
            <div class="card p-4">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Select or Drag an Image</label>
                        <input id="fileInput" name="file" type="file" accept="image/*" class="form-control" required>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-accent" id="predictBtn">Predict</button>
                        <button type="button" class="btn btn-secondary" id="clearBtn">Clear</button>
                    </div>
                </form>
                <div id="uploadError" class="alert alert-danger mt-3" style="display:none;"></div>
                <div class="mt-3">
                    <small class="text-muted">Uploaded image preview:</small>
                    <img id="previewImg" class="img-fluid mt-2" style="display:none;" alt="Uploaded Preview">
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-4">
                <div id="status" class="text-muted">No prediction yet.</div>
                <div id="resultCard" class="mt-3" style="display:none;">
                    <h4 id="predLabel">Loading...</h4>  <!-- Added default text -->
                    <p id="predDesc">Loading description...</p>  <!-- Added default text -->
                    <div class="mt-3">
                        <small class="text-muted">Reference Image:</small>
                        <img id="vehicleImg" class="img-fluid mt-2" style="display:none;" alt="Vehicle Reference">
                    </div>
                    <div class="mt-3 d-flex gap-2">
                        <button id="downloadBtn" class="btn btn-success">Download Uploaded</button>
                        <button id="shareBtn" class="btn btn-info">Share</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ... (Your existing JavaScript remains unchanged)
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const previewImg = document.getElementById('previewImg');
    const predictBtn = document.getElementById('predictBtn');
    const clearBtn = document.getElementById('clearBtn');
    const status = document.getElementById('status');
    const resultCard = document.getElementById('resultCard');
    const predLabel = document.getElementById('predLabel');
    const predDesc = document.getElementById('predDesc');
    const vehicleImg = document.getElementById('vehicleImg');
    const uploadError = document.getElementById('uploadError');
    const downloadBtn = document.getElementById('downloadBtn');
    const shareBtn = document.getElementById('shareBtn');

    // Handle file selection and preview
    fileInput.addEventListener('change', (e) => {
        if (fileInput.files[0]) {
            handleFileChosen(fileInput.files[0]);
        }
    });

    // Drag & drop support
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        fileInput.addEventListener(eventName, preventDefaults, false);
    });
    fileInput.addEventListener('drop', handleDrop, false);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length) {
            fileInput.files = files;
            handleFileChosen(files[0]);
        }
    }

    function handleFileChosen(file) {
        uploadError.style.display = 'none';
        resultCard.style.display = 'none';
        status.textContent = 'Ready to predict';
        if (!file.type.startsWith('image/')) {
            uploadError.textContent = 'Please select a valid image file.';
            uploadError.style.display = 'block';
            return;
        }
        if (file.size > 6 * 1024 * 1024) {
            uploadError.textContent = 'File too large. Please upload < 6MB.';
            uploadError.style.display = 'block';
            return;
        }
        const reader = new FileReader();
        reader.onload = (ev) => {
            previewImg.src = ev.target.result;
            previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // Clear button
    clearBtn.addEventListener('click', () => {
        fileInput.value = '';
        previewImg.style.display = 'none';
        status.textContent = 'No prediction yet';
        resultCard.style.display = 'none';
        uploadError.style.display = 'none';
    });

    // Form submission and prediction
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Form submitted');
        uploadError.style.display = 'none';
        resultCard.style.display = 'none';
        if (!fileInput.files[0]) {
            uploadError.textContent = 'Please select an image.';
            uploadError.style.display = 'block';
            return;
        }
        status.textContent = 'Predicting...';
        predictBtn.disabled = true;
        predictBtn.textContent = 'Predicting...';
        try {
            const fd = new FormData();
            fd.append('file', fileInput.files[0]);
            console.log('Sending prediction request');
            const resp = await fetch('/api/predict', {
                method: 'POST',
                body: fd
            });
            console.log('Response status:', resp.status);
            if (!resp.ok) {
                const errorText = await resp.text();
                throw new Error(`Server error ${resp.status}: ${errorText}`);
            }
            const data = await resp.json();
            console.log('Full prediction data:', data);  // Debug: Log entire response
            // Force update UI
            predLabel.textContent = data.predicted_class || 'Unknown Class';
            predDesc.textContent = data.description || 'No description available';
            console.log('Updated predLabel to:', predLabel.textContent);  // Debug
            console.log('Updated predDesc to:', predDesc.textContent);  // Debug
            if (data.vehicle_image_url) {
                vehicleImg.src = data.vehicle_image_url;
                vehicleImg.style.display = 'block';
                console.log('Reference image loaded:', data.vehicle_image_url);
            } else {
                vehicleImg.style.display = 'none';
            }
            if (data.uploaded_image) {
                previewImg.src = 'data:image/jpeg;base64,' + data.uploaded_image;
            }
            status.textContent = 'Prediction complete';
            resultCard.style.display = 'block';  // Ensure card is visible
            // Download button
            downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.href = previewImg.src;
                link.download = fileInput.files[0].name || 'uploaded_image.jpg';
                document.body.appendChild(link);
                link.click();
                link.remove();
            };
            // Share button
            shareBtn.onclick = () => {
                const shareUrl = `${window.location.origin}/predict?result=${data.predicted_class}`;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Link copied to clipboard!');
                });
            };
        } catch (err) {
            console.error('Prediction error:', err);
            uploadError.textContent = `Prediction failed: ${err.message}`;
            uploadError.style.display = 'block';
            status.textContent = 'Error';
        } finally {
            predictBtn.disabled = false;
            predictBtn.textContent = 'Predict';
        }
    });
</script>
{% endblock %}